<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0b0b0f">
    <title>goThoom — Web Client</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b0b0f;
        --fg: #dfe4ea;
        --muted: #94a3b8;
        --accent: #7aa2f7;
      }
      html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
      .wrap { display: grid; place-items: center; height: 100%; }
      .status { display: flex; align-items: center; gap: 12px; font-size: 15px; color: var(--muted); }
      .spinner { width: 18px; height: 18px; border: 3px solid transparent; border-top-color: var(--accent); border-right-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .hidden { display: none !important; }
      noscript { position: fixed; inset: 0; display: grid; place-items: center; background: var(--bg); color: var(--fg); }
      canvas { outline: none; }
    </style>
  </head>
  <body>
    <div id="boot" class="wrap">
      <div class="status">
        <div class="spinner" aria-hidden="true"></div>
        <div id="msg">Loading goThoom…</div>
      </div>
    </div>
    <noscript>JavaScript is required to run goThoom in the browser.</noscript>
    <script src="wasm_exec.js"></script>
    <script type="module">
      import brotliPromise from 'https://unpkg.com/brotli-dec-wasm@2.3.0/index.js?module';

      (async () => {
        const boot = document.getElementById('boot');
        const msg = document.getElementById('msg');
        const setMsg = (t) => { if (msg) msg.textContent = t; };

        if (!WebAssembly.instantiateStreaming) {
          WebAssembly.instantiateStreaming = async (resp, importObject) => {
            const source = await resp.arrayBuffer();
            return await WebAssembly.instantiate(source, importObject);
          };
        }

        const go = new Go();
        setMsg('Fetching core…');

        try {
          const brotli = await brotliPromise;
          const resp = await fetch('gothoom.wasm.br', { cache: 'no-cache' });
          if (!resp.ok) {
            throw new Error(`Failed to fetch gothoom.wasm.br (${resp.status})`);
          }

          let compressed;
          if (resp.body && resp.body.getReader) {
            const reader = resp.body.getReader();
            const chunks = [];
            let total = 0;
            while (true) {
              const { done, value } = await reader.read();
              if (done) {
                break;
              }
              chunks.push(value);
              total += value.length;
            }
            compressed = new Uint8Array(total);
            let offset = 0;
            for (const chunk of chunks) {
              compressed.set(chunk, offset);
              offset += chunk.length;
            }
          } else {
            compressed = new Uint8Array(await resp.arrayBuffer());
          }

          setMsg('Decompressing…');
          const decompressed = brotli.decompress(compressed);

          setMsg('Starting…');
          const { instance } = await WebAssembly.instantiate(decompressed, go.importObject);
          boot && boot.classList.add('hidden');
          go.run(instance);
        } catch (e) {
          console.error(e);
          setMsg('Failed to start');
          const pre = document.createElement('pre');
          pre.textContent = (e && (e.stack || e.message)) || String(e);
          document.body.appendChild(pre);
        }
      })();
    </script>
  </body>
  <!-- Note: build scripts ship gothoom.wasm.br only; serve with Content-Type: application/wasm. -->
</html>
